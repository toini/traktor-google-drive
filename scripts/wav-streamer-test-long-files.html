<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Streaming WAV Player</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    #waveform {
      height: 100px;
      background: #eee;
      position: relative;
      margin-bottom: 1em;
      cursor: pointer;
    }

    #waveform::after {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      width: var(--progress, 0%);
      background: orange;
    }

    #time,
    #duration {
      font-size: 12px;
      color: #666;
    }

    #loginBtn {
      display: none;
      margin-bottom: 1em;
    }
  </style>
</head>

<body>
  <h2>Streaming WAV Player (via MediaSource)</h2>
  <button id="loginBtn">Login with Google</button>
  <div id="waveform"></div>
  <div>
    <span id="time">0:00</span> / <span id="duration">2:00:00</span>
  </div>
  <audio id="player" controls style="width: 100%"></audio>

  <script>
    const fileId = '16dVOEEC_tTfUukFZYehUzkBErUWB04h6';
    const sampleRate = 44100, byteRate = 176400;
    const totalDuration = 7200; // seconds (2 hours)
    const chunkSeconds = 10;
    const player = document.getElementById('player');
    const loginBtn = document.getElementById('loginBtn');
    const waveform = document.getElementById('waveform');
    const timeEl = document.getElementById('time');
    const durationEl = document.getElementById('duration');
    let token = sessionStorage.getItem("access_token");

    const formatTime = s => `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, '0')}`;
    durationEl.textContent = formatTime(totalDuration);

    waveform.addEventListener('click', async e => {
      const rect = waveform.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      const seekSeconds = Math.floor(ratio * totalDuration);
      console.log(`Seeking to ${seekSeconds}s`);
      await streamChunk(seekSeconds);
    });

    player.addEventListener('timeupdate', () => {
      timeEl.textContent = formatTime(player.currentTime);
      waveform.style.setProperty('--progress', `${(player.currentTime / totalDuration) * 100}%`);
    });

    window.googleLogin = () => {
      if (!window.tokenClient) {
        window.tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: '219145501841-n6pki0jbvkue0u3vusmnguld6m4fugp9.apps.googleusercontent.com',
          scope: 'https://www.googleapis.com/auth/drive.readonly',
          callback: res => {
            if (res?.access_token) {
              sessionStorage.setItem("access_token", res.access_token);
              token = res.access_token;
              loginBtn.style.display = 'none';
              initMediaSource();
            }
          }
        });
      }
      window.tokenClient.requestAccessToken();
    };

    if (!token) {
      loginBtn.style.display = "inline-block";
      loginBtn.addEventListener("click", window.googleLogin);
    } else {
      loginBtn.style.display = "none";
      initMediaSource();
    }

    let mediaSource;
    let sourceBuffer;
    function initMediaSource() {
      mediaSource = new MediaSource();
      player.src = URL.createObjectURL(mediaSource);
      mediaSource.addEventListener('sourceopen', async () => {
        try {
          sourceBuffer = mediaSource.addSourceBuffer('audio/wav; codecs=1');
          await streamChunk(0);
        } catch (e) {
          console.error("SourceBuffer error:", e);
        }
      });
    }

    async function streamChunk(seekSeconds) {
      const offset = 44 + Math.floor(seekSeconds * byteRate);
      const length = chunkSeconds * byteRate;
      const range = `bytes=${offset}-${offset + length - 1}`;
      console.log(`ðŸ“¦ Fetching: ${range}`);

      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
        headers: {
          Authorization: `Bearer ${token}`,
          Range: range
        }
      });

      if (!res.ok) {
        alert(`Fetch error: ${res.status}`);
        return;
      }

      const chunk = new Uint8Array(await res.arrayBuffer());
      const wav = buildWav(chunk);
      sourceBuffer.appendBuffer(wav);
      console.log(`âœ… Appended ${chunk.length} bytes`);
    }

    function buildWav(samples) {
      const channels = 2, bitsPerSample = 16;
      const blockAlign = channels * bitsPerSample / 8;
      const byteRate = sampleRate * blockAlign;
      const dataSize = samples.length;
      const buffer = new ArrayBuffer(44 + dataSize);
      const view = new DataView(buffer);
      const write = (i, s) => [...s].forEach((c, j) => view.setUint8(i + j, c.charCodeAt(0)));

      write(0, 'RIFF');
      view.setUint32(4, 36 + dataSize, true);
      write(8, 'WAVE');
      write(12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, channels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, byteRate, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitsPerSample, true);
      write(36, 'data');
      view.setUint32(40, dataSize, true);
      new Uint8Array(buffer).set(samples, 44);
      return new Uint8Array(buffer);
    }
  </script>
</body>

</html>