@namespace TraktorGoogleDrive.Components
@using Microsoft.JSInterop
@inject IJSRuntime JS
@using TraktorGoogleDrive.Models

<div style="margin-bottom: 0.5rem;">
    <b>@File?.Name</b>
</div>

<div id="@WaveformId" style="width: 100%; height: 128px; margin-bottom: 1em;"></div>
<button @onclick="PlayPause">▶️ Play/Pause</button>

@code {
    [Parameter] public FileEntry? File { get; set; }
    [Parameter] public string? Token { get; set; }

    string WaveformId = $"waveform_{Guid.NewGuid():N}";
    IJSObjectReference? waveSurferInstance;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Console.WriteLine($"[AudioTrack] OnAfterRenderAsync"); 
        if (firstRender && File != null)
        {
            var wavUrl = $"/api/proxy/drive/{File.Id}?token={Token}";
            Console.WriteLine($"[AudioTrack] Name={File.Name}, Id={File.Id}, MimeType={File.MimeType}, PlaytimeFloat={File.PlaytimeFloat}, wavUrl={wavUrl}");
            waveSurferInstance = await JS.InvokeAsync<IJSObjectReference>(
                "initWaveSurfer", WaveformId, wavUrl, File.PeaksUrl, File.PlaytimeFloat);
        }
    }

    async Task PlayPause()
    {
        if (waveSurferInstance is not null)
        {
            await JS.InvokeVoidAsync("waveSurferPlayPause", waveSurferInstance);
        }
    }
}
