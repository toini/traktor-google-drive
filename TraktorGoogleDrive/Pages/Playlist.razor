@page "/playlist/{Uuid}"
@inject HttpClient Http
@inject IJSRuntime JS
@inject TraktorGoogleDrive.Services.CollectionService CollectionService

@using TraktorGoogleDrive.Components
@using TraktorNmlParser.Models
@using TraktorGoogleDrive.Models
@using System.Text.Json
@using System.Diagnostics;

<h3>@Name</h3>

@if (tracks is null)
{
    <p>Loading tracks...</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Artist</th>
                <th>Release</th>
                <th>Label</th>
                <th>Comment</th>
                <th>Playtime</th>
                <th>Path</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var file in files)
            {
                <tr>
                    <td>@file.Track.Title</td>
                    <td>@file.Track.Artist</td>
                    <td>@Path.GetFileName(Path.GetDirectoryName(file.Track.Path))</td>
                    <td>@file.Track.Label</td>
                    <td>@file.Track.Comment</td>
                    <td>@(file.Track.PlaytimeFloat?.ToString("0.0") ?? "") s</td>
                    <td>@file.Track.Path</td>
                    <td>
                        @if (!string.IsNullOrEmpty(file.Id))
                        {
                            <AudioTrack File="@file" Token="@token" />
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    [Parameter] public string? Uuid { get; set; }

    string? Name;
    List<FileEntry> files = [];
    string? token;

    protected override async Task OnParametersSetAsync()
    {
        var watch = Stopwatch.StartNew();
        Console.WriteLine($"Loading playlist with UUID: {Uuid}");
        var playlist = await CollectionService.GetPlaylistByUuid(Uuid);
        if (playlist is null) return;
        Console.WriteLine($"Playlist loaded at {watch.Elapsed.TotalSeconds}s");

        Name = playlist.Name;

        // Log all paths
        foreach (var t in playlist.Tracks)
        {
            Console.WriteLine($"Track path: {t.Path}");
        }

        token = await JS.InvokeAsync<string>("sessionStorage.getItem", "access_token");

        // Extract unique filenames
        var filenames = playlist.Tracks.Select(t => Path.GetFileName(t.Path)).Distinct();
        foreach (var t in filenames)
        {
            Console.WriteLine($"Filename: {t}");
        }

        Console.WriteLine($"Start drive query {watch.Elapsed.TotalSeconds}s");
        var nameConditions = string.Join(" or ", filenames.Select(f => $"name = '{f.Replace("'", "\\'")}'"));
        var query = $"mimeType contains 'audio/' and ({nameConditions})";

        var json = await Http.GetFromJsonAsync<JsonElement>(
        $"https://www.googleapis.com/drive/v3/files?q={Uri.EscapeDataString(query)}&fields=files(id,name,mimeType)&access_token={token}"
        );
        Console.WriteLine($"Drive raw file query done {watch.Elapsed.TotalSeconds}s");

        // Map files from playlist tracks, matching to Drive files by filename
        var driveFiles = json.GetProperty("files").EnumerateArray().Select(f => new FileEntry
        {
            Id = f.GetProperty("id").GetString()!,
            Name = f.GetProperty("name").GetString()!,
            MimeType = f.GetProperty("mimeType").GetString()!,
        }).ToList();

        files = tracks.Select(t =>
        {
            var file = driveFiles.FirstOrDefault(f => f.Name == Path.GetFileName(t.Path));
            Console.WriteLine($"Track path: {t.Path} | Matched file: {(file != null ? file.Name : "(none)")}");
            return new FileEntry
            {
                Id = file?.Id ?? string.Empty,
                MimeType = file?.MimeType ?? "audio/wav",
                PeaksUrl = "",
                Track = t
            };
        }).ToList();

        Console.WriteLine($"Page loaded {watch.Elapsed.TotalSeconds}s");
    }
}
