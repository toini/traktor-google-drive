@page "/music"
@inject IJSRuntime JS
@inject HttpClient Http
@using System.Text.Json

<h3>Drive Music</h3>

@if (files is null)
{
    <p>Loading...</p>
}
else
{
    @foreach (var file in files)
    {
        <div style="margin-bottom: 1rem;" @key="file.Id">
            <p>@file.Name</p>
            <button @onclick="@(() => StreamAudio(file))">▶️ Stream</button>
        </div>
    }
}

@code {
    class FileEntry
    {
        public string Name { get; set; }
        public string Id { get; set; }
        public string MimeType { get; set; }
        //public ElementReference AudioRef { get; set; }
    }

    List<FileEntry> files;
    string token;
    HashSet<string> streamed = new();

    async Task StreamAudio(FileEntry file)
    {
        if (streamed.Contains(file.Id)) return;
        streamed.Add(file.Id);

        Console.WriteLine($"Streaming: {file.Id}");
        await JS.InvokeVoidAsync("secureStreamToAudio", file.Id, token, file.MimeType);
    }

    protected override async Task OnInitializedAsync()
    {
        token = await JS.InvokeAsync<string>("sessionStorage.getItem", "access_token");

        var result = await Http.GetFromJsonAsync<JsonElement>(
            $"https://www.googleapis.com/drive/v3/files?q=mimeType contains 'audio/'&fields=files(id,name,mimeType)&access_token={token}"
        );

        files = result.GetProperty("files").EnumerateArray()
            .Select(f => new FileEntry
                {
                    Id = f.GetProperty("id").GetString(),
                    Name = f.GetProperty("name").GetString(),
                    MimeType = f.GetProperty("mimeType").GetString()                    
                })
            .ToList();
    }
}
